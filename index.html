<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title id="metaTitle"></title>
    <meta name="description" id="metaDescription" content="" />
    <meta name="author" id="metaAuthor" content="" />
    <meta property="og:image" id="ogImage" content="/og-image.png" />
    <link rel="icon" type="image/png" sizes="32x32" href="" />
    <link rel="icon" type="image/png" sizes="16x16" href="" />
    <link rel="apple-touch-icon" sizes="180x180" href="" />
    <script type="module">
      // Set meta title, description and author from environment variables
      document.getElementById('metaTitle').textContent = import.meta.env.VITE_META_TITLE;
      document.getElementById('metaDescription').content = import.meta.env.VITE_META_DESCRIPTION;
      document.getElementById('metaAuthor').content = import.meta.env.VITE_META_AUTHOR;

      // Get environment variables
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseAnonKey = import.meta.env.VITE_SUPABASE_ANON_KEY;

      // Function to update favicon with cache buster
      const updateFavicon = async () => {
        try {
          const { data, error } = await fetch(`${supabaseUrl}/rest/v1/branding?key=eq.favicon`, {
            headers: {
              'apikey': supabaseAnonKey
            }
          }).then(res => res.json());

          if (error) throw error;
          
          if (data?.[0]?.value) {
            const timestamp = new Date().getTime();
            const faviconUrl = `${data[0].value}?t=${timestamp}`;
            
            document.querySelector('link[sizes="32x32"]').href = faviconUrl;
            document.querySelector('link[sizes="16x16"]').href = faviconUrl;
            document.querySelector('link[rel="apple-touch-icon"]').href = faviconUrl;
          }
        } catch (error) {
          console.error('Error updating favicon:', error);
        }
      };

      // Update favicon immediately and when window gains focus
      updateFavicon();
      window.addEventListener('focus', updateFavicon);

      // Fetch and update meta description and OG image
      fetch(`${supabaseUrl}/rest/v1/branding`, {
        headers: {
          'apikey': supabaseAnonKey
        }
      })
      .then(response => response.json())
      .then(data => {
        const brandingMap = data.reduce((acc, item) => {
          acc[item.key] = item.value;
          return acc;
        }, {});

        // Update meta description
        if (brandingMap.header_title && brandingMap.header_subtitle) {
          document.getElementById('metaDescription').content = `${brandingMap.header_title} - ${brandingMap.header_subtitle}`;
        }

        // Update OG image with cache buster
        if (brandingMap.profile_picture) {
          const timestamp = new Date().getTime();
          document.getElementById('ogImage').content = `${brandingMap.profile_picture}?t=${timestamp}`;
        }
      })
      .catch(error => console.error('Error fetching branding:', error));
    </script>
  </head>
  <body>
    <div id="root"></div>
    <script src="https://cdn.gpteng.co/gptengineer.js" type="module"></script>
    <script type="module" src="/src/main.tsx"></script>
  </body>
</html>